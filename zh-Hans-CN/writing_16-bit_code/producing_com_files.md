7.2 产生`.COM`文件
======

一个大的 DOS 程序最好是写成`.EXE`文件，但一个小的程序往往最好写成`.COM`文件。

`.COM`文件是纯二进制的，所以使用`bin`输出格式可以很容易的地产生。


## 7.2.1 使用`bin`格式产生`.COM`文件。

`.COM`文件预期被装载到它们所在段的`100h`偏移处(尽管段可能会变)。

然后从 100h 处开始执行，所以要写一个`.COM`程序，你应当象下面这样写代码:

```nasm
               org 100h 
       
       section .text 
       
       start: 
               ; put your code here 
       
       section .data 
       
               ; put data items here 
       
       section .bss 
       
               ; put uninitialised data here
```

`bin`格式会把`.text`段放在文件的最开始处，所以如果你需要，你可以在开始编写代码前先声明 data 和 bss 元素，代码段最终还是会放到文件的最开始处。

BSS(未初始化过的数据)段本身在`.COM`文件中并不占据空间:BSS 中的元素的地址是一个指向文件外面的一个空间的一个指针，这样做的依据是在程序运行中，这样可以节省空间。

所以你不应当相信当你运行程序时，你的 BSS 段已经被初始化为零了。

为了汇编上面的程序，你应当象下面这样使用命令行:

```shell
$ nasm myprog.asm -fbin -o myprog.com
```

如果没有显式的指定输出文件名，这个`bin`格式会产生一个叫做`myprog`的文件，所以你必须重新给它指定一个文件名。


## 7.2.2 使用`obj`格式产生`.COM`文件

如果你在写一个`.COM`文件的时候，产生了多于一个的模块，你可能希望汇编成多个`.OBJ`文件，然后把它们连接成一个`.COM`程序。

如果你拥有一个能够输出`.COM`文件的连接器，你可以做到这一点。

或者拥有一个转化程序(比如，`EXE2BIN`)把一个`.EXE`输出文件转化为一个`.COM`文件也可。

如果你要这样做，你必须注意几件事情:
*  第一个含有代码的目标文件在它的代码段中，第一句必须是:`RESB 100h`。这是为了保证代码在代码段基址的偏移`100h`处开始，这样，连接器和转化程序在产生.com 文件时，就不必调整地址引用了。其他的汇编器是使用`ORG`操作符来达到此目的的，但是`ORG`在 NASM 中对于`bin`格式来说是一个格式相关的操作符，会表达不同的含义。
*  你不必定义一个堆栈段。
*  你的所有段必须放在一个组中，这样每次你的代码或数据引用一个符号偏移时，所有的偏移值都是相对于同一个段基址的。这是因为，当一个`.COM`文件载入时，所有的段寄存器含有同一个值。
