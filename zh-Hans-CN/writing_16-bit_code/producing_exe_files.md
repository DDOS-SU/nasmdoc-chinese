7.1 产生`.EXE`文件.
======

DOS 下的任何大的程序都必须被构建成`.EXE`文件，因为只有`.EXE`文件拥有一种内部结构可以突破 64K 的段限制.Windows 程序也需要被构建成`.EXE`文件，因为Windows 不支持`.COM`格式.一般的，你是通过使用一个或多个`obj`格式的`.OBJ`目标文件来产生`.EXE`文件的，用连接器把它们连接到一起.但是，NASM 也支持通过`bin`输出格式直接产生一个简单的 DOS `.EXE`文件(通过使用`DB`和`DW`来构建 exe 文件头)，并提供了一组宏帮助做到这一点.多谢 Yann Guidon 贡献了这一部分代码.在 NASM 的未来版本中，可能会完全支持`.EXE`文件.

## 7.1.1 使用`obj`格式来产生`.EXE`文件.

本章选描述常见的产生`.EXE`文件的方法:把`.OBJ`文件连接到一起.大多数 16 位的程序语言包都附带有一个配套的连接器，如果你没有，有一个免费的叫做 VAL 的连接器，在`x2ftp.oulu.fi`上可以以`LZH`包的格式得到.也可以在`ftp.simtel.net`上得到. 另一个免费的 LZH 包(尽管这个包是没有源代码的)，叫做FREELINK，可以在`www.pcorner.com`上得到. 第三个是`djlink`，是由 DJ Delorie 写的，可以在`www.delorie.com`上得到. 第四个 `ALINK`， 是由 Anthony A.J. Williams写的，可以在`alink.sourceforge.net`上得到.当把多个`.OBJ`连接进一个`.EXE`文件中的时候，你需要保证它们当中有且仅有一个含有程序入口点(使用`obj`格式定义的特殊符号`..start`参阅 6.2.6).如果没有模块定义入口点，连接器就不知道在输出文件的文件头中为入口点域赋什么值，如果有多个入口被定义，连接器就不知道到底该用哪一个.一个关于把 NASM 源文件汇编成`.OBJ`文件，并把它连接成一个`.EXE`文件的例子在这里给出.它演示了定义栈，初始化段寄存器，声明入口点的基本做法.这个文件也在 NASM 的`test`子目录中有提供，名字是`objexe.asm`.

```nasm
       segment code 
       
       ..start: 
               mov     ax,data 
               mov     ds,ax 
               mov     ax,stack 
               mov     ss,ax 
               mov     sp,stacktop
```

这是一段初始化代码，先把 DS 寄存器设置成指定数据段，然后把`SS`和`SP`寄存器设置成指定提供的栈。

注意，这种情况下，在`mov ss，ax`后，有一条指令隐式地把中断关闭掉了，这样抗敌，在载入 `SS`和`SP`的过程中就不会有中断发生，并且没有可执行的栈可用。

还有，一个特殊的符号`..start`在这段代码的开头被定义，它表示最终可执行代码的入口点。

```nasm
               mov     dx,hello 
               mov     ah,9 
               int     0x21
```

上面是主程序:在`DS:DX`中载入一个指向欢迎信息的指针(`hello`隐式的跟段`data`相关联，`data`在设置代码中已经被载入到`DS`寄存器中，所以整个指针是有效的)，然后调用 DOS 的打印字符串功能调用。

```nasm
               mov     ax,0x4c00 
               int     0x21
```

这两句使用另一个 DOS 功能调用结束程序。

```nasm
       segment data 
       
       hello:  db      'hello, world', 13, 10, '$'
```

数据段中含有我们想要显示的字符串。

```nasm
       segment stack stack 
               resb 64 
       stacktop:
```

上面的代码声明一个含有 64bytes 的未初始化栈空间的堆栈段，然后把指针`stacktop`指向它的顶端。

操作符`segment stack stack`定义了一个叫做`stack`的段，同时它的类型也是`STACK`.后者并不一定需要，但是连接串可能会因为你的程序中没有段的类型为`STACK`而发出警告。

上面的文件在被编译为`.OBJ`文件中，会自动连接成为一个有效的`.EXE`文件，当运行它时会打印出`hello world`，然后退出。

## 7.1.2 使用`bin`格式来产生`.EXE`文件。

`.EXE`文件是相当简单的，所以可以通过编写一个纯二进制文件然后在前面连接上一个 32bytes 的头就可以产生一个`.exe`的文件了。

这个文件头也是相当简单，它可以通过使用 NASM 自己的`DB`和`DW`命令来产生，所以你可以使用`bin`输出格式直接产生`.EXE`文件。

在 NASM 的包中，有一个`misc`子目录，这是一个宏文件`exebin.mac`。

它定义了三个宏`EXE_begin`，`EXE_stack`和`EXE_end`.要通过这种方法产生一个`.EXE`文件，你应当开始的时候先使用`%include`载入`exebin.mac`宏包到你的源文件中。

然后，你应当使用`EXE_begin`宏(不带任何参数)来产生文件头数据。

然后像平常一样写二进制格式的代码-你可以使用三种标准的段`.text`，`.data`，`.bss`.在文件的最后，你应当调用`EXE_end`宏(还是不带任何参数)，它定义了一些标识段 size 的符号，而这些宏会由`EXE_begin`产生的文件头代码引用。

在这个模块中，你最后的代码是写在`0x100`开始的地址处的，就像是`.COM`文件-实际上，如果你剥去那个 32bytes 的文件头，你就会得到一个有效的`.COM`程序。

所有的段基址是相同的，所以程序的大小被限制在 64K 的范围内，这还是跟一个`.COM`文件相同。

`ORG`操作符是被`EXE_begin`宏使用的，所以你不必自己显式的使用它你可以直接使用你的段基址，但不幸的是，因为这需要在文件头中有一个重定位，事情就会变得更复杂。

所以你应当从`CS`中拷贝出一个段基址。

进入你的`.EXE`文件后，`SS:SP`已经被正确的指向一个 2Kb 的栈顶。

你可以通过调用`EXE_stack`宏来调整缺省的 2KB 的栈大小。

比如，把你的栈 size 改变到64bytes，你可以调用`EXE_stack 64`一个关于以这种方式产生一个`.EXE`文件的例子在 NASM 包的子目录`test`中，名字是`binexe.asm`
